<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glorious Battery Monitor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233fb950' stroke-width='2'><rect x='2' y='7' width='18' height='11' rx='2'/><path d='M22 10v4'/></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{
          --bg:#0d1117;--panel:#161b22;--ink:#c9d1d9;--ink-muted:#8b949e;--border:#30363d;--accent:#3fb950;--warn:#d29922;--low:#f85149;--chg:#58a6ff;
          --ok:#238636;--ok-2:#2ea043;--err:#d83a3a;--focus:#1f6feb;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--ink); display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
        .container { width: 100%; max-width: 420px; background: var(--panel); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,.45); }
        .header { padding: 22px; text-align: center; border-bottom: 1px solid #21262d; position: relative; }
        .title { font-size: 20px; font-weight: 700; color: #f0f6fc; margin-bottom: 4px; letter-spacing: .2px; }
        .subtitle { font-size: 13px; color: var(--ink-muted); }
        .content { padding: 28px 22px 26px; }

        /* BATTERY GAUGE */
        .battery-circle { position: relative; width: 210px; height: 210px; margin: 0 auto 24px; }
        .circle-svg { width: 100%; height: 100%; transform: rotate(-90deg); display:block; }
        .circle-bg { fill: none; stroke: #1f2430; stroke-width: 14; }
        .circle-progress { fill: none; stroke: var(--accent); stroke-width: 14; stroke-linecap: round; transition: stroke-dashoffset .7s cubic-bezier(.25,.9,.25,1), stroke .25s ease; filter: drop-shadow(0 0 8px rgba(63,185,80,.25)); }
        .circle-hole { fill: var(--panel); }

        .battery-center { position: absolute; inset: 0; display:grid; place-content:center; text-align:center; gap:8px; }
        .battery-icon { width: 46px; height: 46px; display:block; margin: 0 auto 2px; color:#cdd6df; opacity:.95 }
        .battery-percentage { font-size: 38px; font-weight: 900; color: #f0f6fc; letter-spacing:-.3px; text-shadow:0 2px 10px rgba(0,0,0,.35); }

        .status { text-align: center; margin-bottom: 22px; }
        .status-badge { display: inline-block; padding: 8px 14px; border-radius: 999px; font-size: 13px; font-weight: 800; border: 1px solid rgba(0,0,0,.0); background: rgba(63, 185, 80, 0.12); color: var(--accent); }
        .status-charging { background: rgba(88, 166, 255, 0.14); color: var(--chg); border-color: #1f6feb22; }
        .status-low { background: rgba(248, 81, 73, 0.14); color: var(--low); border-color: #da363322; }
        .status-disconnected { background: rgba(139, 148, 158, 0.14); color: var(--ink-muted); border-color: #484f5822; }
        .status-fair { background: rgba(210,153,34,.14); color: var(--warn); border-color:#b1811022; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .info-card.full-width { grid-column: 1 / -1; }
        .info-card { background: #0d1117; border: 1px solid var(--border); padding: 14px; border-radius: 10px; text-align: center; position: relative; }
        .info-label { font-size: 11px; color: var(--ink-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .info-value { font-size: 16px; font-weight: 800; color: #f0f6fc; }
        .info-btn { background: transparent; border: 1px solid var(--border); color: var(--ink-muted); width: 16px; height: 16px; border-radius: 50%; font-size: 10px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
        .info-btn:hover { background: #21262d; color: #f0f6fc; border-color: #3a4250; }
        .info-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); background: #21262d; border: 1px solid var(--border); padding: 10px 12px; border-radius: 8px; font-size: 11px; color: var(--ink); width: max-content; max-width: 280px; text-align: left; box-shadow: 0 8px 24px rgba(0,0,0,.4); opacity: 0; pointer-events: none; transition: opacity .2s; z-index: 100; }
        .info-tooltip.show { opacity: 1; pointer-events: auto; }
        .info-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--border); }

        .settings-btn { position: absolute; top: 16px; right: 16px; background: rgba(33,38,45,.35); border: 1px solid var(--border); color: var(--ink-muted); padding: 6px; border-radius: 8px; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .settings-btn:hover { background: #21262d; color: #f0f6fc; border-color: #3a4250; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 22px; width: 90%; max-width: 420px; box-shadow: 0 18px 55px rgba(0,0,0,.55); }
        .modal-header { font-size: 18px; font-weight: 800; margin-bottom: 12px; color: #f0f6fc; display:flex; align-items:center; justify-content:space-between; gap:8px; }
        .modal-sub { font-size:12px; color:var(--ink-muted); margin-bottom: 14px; }
        .setting-item { margin-bottom: 14px; }
        .setting-label { display: block; font-size: 13px; color: var(--ink); margin-bottom: 6px; }
        .hint { font-size: 12px; color: var(--ink-muted); margin-top: 6px; }
        .setting-input { width: 100%; background: #0d1117; border: 1px solid var(--border); color: #f0f6fc; padding: 10px 12px; border-radius: 8px; font-size: 14px; outline:none; }
        .setting-input:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(31,111,235,.25); }
        .input-row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper input { width: auto; accent-color: var(--ok); }
        .modal-actions { display: flex; gap: 8px; margin-top: 18px; }
        .btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; font-weight: 800; cursor: pointer; transition: all 0.15s; }
        .btn-primary { background: var(--ok); color: white; border-color: var(--ok-2); display:inline-flex; align-items:center; justify-content:center; gap:8px; }
        .btn-primary[disabled] { opacity:.7; cursor: not-allowed; }
        .btn-primary:hover:not([disabled]) { background: var(--ok-2); }
        .btn-secondary { background: #21262d; color: #c9d1d9; }
        .btn-secondary:hover { background: #30363d; }
        .close-x { background: transparent; border:1px solid var(--border); color:var(--ink-muted); border-radius:8px; width:32px; height:32px; display:grid; place-items:center; cursor:pointer; }
        .close-x:hover { background:#21262d; color:#f0f6fc }

        /* Toasts */
        .toast-host { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 2000; }
        .toast { background: #111b14; color: #d7ffe1; padding: 12px 14px; border-radius: 10px; border:1px solid #286a3f; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); opacity: 0; transform: translateY(12px) scale(.98); transition: all 220ms cubic-bezier(.2,.8,.2,1); display:flex; align-items:center; gap:10px; min-width: 240px; }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
        .toast .tmsg { flex:1 }
        .toast .tbtn { background: transparent; border:1px solid #2c7a4b; color:#c9fdd7; border-radius: 8px; padding:6px 8px; cursor:pointer; }
        .toast.error { background:#1f1414; color:#ffd7d7; border-color:#6a2828 }
        .toast.info  { background:#111a24; color:#d7e7ff; border-color:#28486a }
        .toast .cls { appearance:none; border:none; background:transparent; color:inherit; cursor:pointer; opacity:.7 }

        /* Small helper */
        .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="openSettings()" aria-label="Open settings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </button>
            <div class="title" id="deviceTitle">Glorious Mouse</div>
            <div class="subtitle">Battery Monitor</div>
        </div>

        <div class="content">
            <div class="battery-circle">
                <svg class="circle-svg" viewBox="0 0 200 200" aria-hidden="true">
                    <circle class="circle-bg" cx="100" cy="100" r="85"></circle>
                    <circle id="progress" class="circle-progress" cx="100" cy="100" r="85"></circle>
                    <circle class="circle-hole" cx="100" cy="100" r="72"></circle>
                </svg>
                <div class="battery-center" aria-live="polite">
                    <svg class="battery-icon" id="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="18" height="11" rx="2"/>
                        <path d="M22 10v4"/>
                    </svg>
                    <div class="battery-percentage" id="percentage">--</div>
                </div>
            </div>

            <div class="status">
                <div class="status-badge" id="status"><span id="status-text">Connecting...</span></div>
            </div>

            <div class="info-grid" id="infoGrid">
                <div class="info-card">
                    <div class="info-label">Last Charged</div>
                    <div class="info-value" id="lastCharge">Never</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Charged To</div>
                    <div class="info-value" id="chargeLevel">--</div>
                </div>
                <div class="info-card full-width" id="timeRemainingCard" style="display:none">
                    <div class="info-label">
                        Time Remaining
                        <button class="info-btn" onclick="toggleTooltip()" aria-label="More info">?</button>
                    </div>
                    <div class="info-value" id="timeRemaining">--</div>
                    <div class="info-tooltip" id="timeTooltip">
                        This estimate is based on your current battery rate (discharge or charge). It may show "Calculating..." until enough data is collected (requires at least 1% battery change).
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-content" role="document">
            <div class="modal-header">
              <span id="settingsTitle">Settings</span>
              <button class="close-x" onclick="closeSettings()" aria-label="Close">✕</button>
            </div>
            <div class="modal-sub">Tune how the app launches, refreshes, and warns you about low battery.</div>

            <div class="setting-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="startWithWindows">
                    <label class="setting-label" for="startWithWindows" style="margin:0">Start with Windows</label>
                </div>
            </div>
            <div class="setting-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="startMinimized">
                    <label class="setting-label" for="startMinimized" style="margin:0">Start Minimized</label>
                </div>
            </div>

            <div class="input-row">
              <div class="setting-item">
                <label class="setting-label" for="refreshInterval">Refresh Interval (seconds)</label>
                <input type="number" id="refreshInterval" class="setting-input" min="1" max="60" value="5">
                <div class="hint">How often to poll the device.</div>
              </div>
              <div class="setting-item">
                <label class="setting-label" for="lowBatteryThreshold">Low Battery Threshold (%)</label>
                <input type="number" id="lowBatteryThreshold" class="setting-input" min="5" max="50" value="20">
                <div class="hint">Show a warning when under this level.</div>
              </div>
            </div>

            <div class="setting-item">
                <label class="setting-label" for="criticalBatteryThreshold">Critical Battery Threshold (%)</label>
                <input type="number" id="criticalBatteryThreshold" class="setting-input" min="5" max="30" value="10">
                <div class="hint">Trigger critical alerts below this level.</div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button id="saveBtn" class="btn btn-primary" onclick="saveSettings()">
                  <span class="spinner sr-only" aria-hidden="true">⏳</span>
                  <span>Save</span>
                </button>
            </div>
        </div>
    </div>

    <div class="toast-host" id="toastHost" aria-live="polite" aria-atomic="true"></div>

    <script>
        let currentSettings = {};

        function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
        function byId(id){ return document.getElementById(id); }

        function toggleTooltip() {
            const tooltip = byId('timeTooltip');
            tooltip.classList.toggle('show');
            setTimeout(() => tooltip.classList.remove('show'), 4000);
        }
        document.addEventListener('click', (e) => {
            const tooltip = byId('timeTooltip');
            if (tooltip && !e.target.closest('.info-card') && tooltip.classList.contains('show')) {
                tooltip.classList.remove('show');
            }
        });

        function getCircumference(circle){
            const r = parseFloat(circle.getAttribute('r')) || 85;
            return 2 * Math.PI * r;
        }

        async function loadSettings() {
            try{
                const response = await fetch('/api/settings');
                currentSettings = await response.json();
                byId('startWithWindows').checked = !!currentSettings.startWithWindows;
                byId('startMinimized').checked = !!currentSettings.startMinimized;
                byId('refreshInterval').value = currentSettings.refreshInterval ?? 5;
                byId('notificationsEnabled') && (byId('notificationsEnabled').checked = !!currentSettings.notificationsEnabled);
                byId('lowBatteryThreshold').value = currentSettings.lowBatteryThreshold ?? 20;
                byId('criticalBatteryThreshold').value = currentSettings.criticalBatteryThreshold ?? 10;
            }catch(e){ showToast('Failed to load settings','error'); }
        }

        function openSettings() {
            loadSettings();
            const modal = byId('settingsModal');
            modal.classList.add('active');
            // focus first control
            setTimeout(()=>{ const first = modal.querySelector('input,button,select,textarea'); first && first.focus(); }, 30);
        }
        function closeSettings() {
            byId('settingsModal').classList.remove('active');
        }

        // click outside to close
        byId('settingsModal').addEventListener('click', (e)=>{ if(e.target === e.currentTarget) closeSettings(); });
        // esc to close
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSettings(); });

        function showToast(message, kind='ok', action){
            const host = byId('toastHost');
            const t = document.createElement('div');
            t.className = `toast ${kind==='error'?'error':kind==='info'?'info':''}`;
            t.innerHTML = `
              <span class="ticon" aria-hidden="true">${kind==='error'?'⚠️':kind==='info'?'ℹ️':'✅'}</span>
              <span class="tmsg">${message}</span>
              ${action?`<button class="tbtn" type="button">${action.label}</button>`:''}
              <button class="cls" aria-label="Dismiss">✕</button>
            `;
            host.appendChild(t);
            requestAnimationFrame(()=> t.classList.add('show'));
            const remove=()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); };
            t.querySelector('.cls').onclick=remove;
            if(action && typeof action.onClick==='function'){
              t.querySelector('.tbtn').onclick=()=>{ action.onClick(); remove(); };
            }
            setTimeout(remove, 2600);
        }

        async function saveSettings() {
            const btn = byId('saveBtn');
            btn.setAttribute('disabled','');
            btn.querySelector('.spinner').classList.remove('sr-only');
            const payload = {
                startWithWindows: byId('startWithWindows').checked,
                startMinimized: byId('startMinimized').checked,
                refreshInterval: clamp(parseInt(byId('refreshInterval').value, 10) || 5, 1, 60),
                notificationsEnabled: byId('notificationsEnabled') ? byId('notificationsEnabled').checked : currentSettings.notificationsEnabled,
                lowBatteryThreshold: clamp(parseInt(byId('lowBatteryThreshold').value, 10) || 20, 5, 50),
                criticalBatteryThreshold: clamp(parseInt(byId('criticalBatteryThreshold').value, 10) || 10, 5, 30)
            };
            // inline validation visuals
            ['refreshInterval','lowBatteryThreshold','criticalBatteryThreshold'].forEach(id=>{
              const el=byId(id); const min=parseInt(el.min||'0',10); const max=parseInt(el.max||'999',10); const v=parseInt(el.value,10);
              if(isNaN(v) || v<min || v>max){ el.style.borderColor='var(--low)'; el.style.boxShadow='0 0 0 2px rgba(248,81,73,.25)'; } else { el.style.borderColor='var(--border)'; el.style.boxShadow='none'; }
            });

            try{
                const res = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error('Save failed');
                showToast('Settings saved','ok');
                closeSettings();
            }catch(e){
                showToast('Failed to save settings','error');
            }finally{
                btn.removeAttribute('disabled');
                btn.querySelector('.spinner').classList.add('sr-only');
            }
        }

        const progress = document.getElementById('progress');
        const circumference = getCircumference(progress);
        progress.style.strokeDasharray = circumference.toFixed(2);
        progress.style.strokeDashoffset = circumference.toFixed(2);

        const eventSource = new EventSource('/events');
        eventSource.onmessage = function(event) {
            try { const data = JSON.parse(event.data); updateBattery(data); } catch(e){}
        };

        function updateBattery(data) {
            const percentage = document.getElementById('percentage');
            const icon = document.getElementById('icon');
            const status = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            const lastCharge = document.getElementById('lastCharge');
            const chargeLevel = document.getElementById('chargeLevel');
            const deviceTitle = document.getElementById('deviceTitle');

            if (data.deviceModel && data.deviceModel !== 'Unknown') {
                deviceTitle.textContent = 'Glorious ' + data.deviceModel;
            }

            if (data.status === 'disconnected') {
                percentage.textContent = '--';
                icon.innerHTML = '<circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/>';
                status.className = 'status-badge status-disconnected';
                statusText.textContent = 'Not Connected';
                progress.style.strokeDashoffset = circumference.toFixed(2);
                return;
            }

            if (data.lastChargeTime && data.lastChargeTime !== 'Never') {
                lastCharge.textContent = data.lastChargeTime;
                chargeLevel.textContent = (data.lastChargeLevel ?? '--') + '%';
            }

            const timeRemainingCard = document.getElementById('timeRemainingCard');
            const timeRemaining = document.getElementById('timeRemaining');
            const timeLabel = timeRemainingCard.querySelector('.info-label');
            if (data.timeRemaining && data.timeRemaining !== '') {
                timeRemaining.textContent = data.timeRemaining;
                if (data.charging) {
                    timeLabel.childNodes[0].textContent = 'Time to Full ';
                } else {
                    timeLabel.childNodes[0].textContent = 'Time Remaining ';
                }
                timeRemainingCard.style.display = 'block';
            } else if (data.charging) {
                timeRemaining.textContent = 'Calculating...';
                timeLabel.childNodes[0].textContent = 'Time to Full ';
                timeRemainingCard.style.display = 'block';
            } else if (!data.charging) {
                timeRemaining.textContent = 'Calculating...';
                timeLabel.childNodes[0].textContent = 'Time Remaining ';
                timeRemainingCard.style.display = 'block';
            }

            const level = Math.max(0, Math.min(100, parseInt(data.level,10) || 0));
            percentage.textContent = level + '%';

            const offset = Math.max(0, circumference * (1 - (level/100)) - 0.001);
            progress.style.strokeDashoffset = offset.toFixed(3);

            if (data.charging) {
                icon.innerHTML = '<path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>';
                progress.style.stroke = 'var(--chg)';
                status.className = 'status-badge status-charging';
                statusText.textContent = 'Charging';
            } else if (level >= 50) {
                icon.innerHTML = '<rect x="2" y="7" width="18" height="11" rx="2"/><path d="M22 10v4"/>';
                progress.style.stroke = 'var(--accent)';
                status.className = 'status-badge';
                statusText.textContent = 'Good';
            } else if (level >= 20) {
                icon.innerHTML = '<rect x="2" y="7" width="18" height="11" rx="2"/><path d="M22 10v4"/>';
                progress.style.stroke = 'var(--warn)';
                status.className = 'status-badge status-fair';
                statusText.textContent = 'Fair';
            } else {
                icon.innerHTML = '<rect x="2" y="7" width="18" height="11" rx="2"/><path d="M22 10v4"/><line x1="6" y1="12" x2="10" y2="12" stroke-width="3"/>';
                progress.style.stroke = 'var(--low)';
                status.className = 'status-badge status-low';
                statusText.textContent = 'Low';
            }
        }
    </script>
</body>
</html>
